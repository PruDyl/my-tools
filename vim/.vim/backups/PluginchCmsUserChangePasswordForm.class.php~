<?php
class PluginchCmsUserChangePasswordForm extends BaseForm
{
  public function __construct($defaults = array(), $options = array(), $CSRFSecret = null)
  {
    parent::__construct(array(), $options, $CSRFSecret);
  }

  public function configure()
  {
    $this->setWidgets(array(
      'old_pass' => new sfWidgetFormInputPassword(),
      'new_pass' => new sfWidgetFormInputPassword(),
      'new_pass_confirm' => new sfWidgetFormInputPassword(),
      'send_mail' => new sfWidgetFormInputCheckbox()
    ));
    unset($this[$this->getCSRFFieldName()]);

    $this->validatorSchema->setPostValidator(new sfValidatorSchemaCompare(
       'new_pass', sfValidatorSchemaCompare::EQUAL, 'new_pass_confirm',
        array('throw_global_error' => true),
        array('invalid' => 'The two passwords must be the same.')
    ));

    $this->setValidators(array(
      'old_pass' => new sfValidatorCallback(array(
          'callback' => array('chCmsLogin', 'checkCurrentUserPassword'),
          'required' => false
      ), array(
          'invalid' => 'You have to provide your current password'
      )),
      'new_pass' => new sfValidatorString(array(
          'min_length' => 5,
          'required' => false
        ),array(
          'min_length' => 'password should contain more than %min_length% characters',
      )),
      'new_pass_confirm' => new sfValidatorString(array(
          'min_length' => 5,
          'required' => false
        ),array(
          'min_length' => 'password should contain more than %min_length% characters',
      )),
      'send_mail' => new sfValidatorBoolean()
    ));

    $this->widgetSchema->setLabels(array(
      'old_pass' => 'old password',
      'new_pass' => 'new password',
      'new_pass_confirm' => 'confirm new password',
      'send_mail' => 'send me a mail with my new password'
    ));

    $this->widgetSchema->setHelps(array(
      'old_pass' => 'provide your current password',
      'new_pass' => 'enter the password you want to use now',
      'new_pass_confirm' => 'confirm your new password'
    ));

    $this->widgetSchema->setNameFormat('change_pass[%s]');
    $this->adaptToUser();
    chTools::setFormFormatter($this);
  }

  /**
   * Adapt the form to the current user :
   *  - if the user only has a provider to log in, he can't enter its old password
   *
   * @return void
   * @author Kevin Gomez <kevin_gomez@carpe-hora.com>
   **/
  protected function adaptToUser()
  {
    if ($this->getUser()->hasDummyPassword())
    {
      // remove the "old password" field
      $this->useFields(array('new_pass', 'new_pass_confirm', 'send_mail'));
    }
  }

  public function save($con = null)
  {
    if (!strlen($this->getValue('old_pass')))

    $con = is_null($con) ? Propel::getConnection(sfGuardUserPeer::DATABASE_NAME) : $con;
    $con->beginTransaction();
    try
    {
      $user = sfGuardUserPeer::retrieveByPk(sfContext::getInstance()->getUser()->getGuardUser()->getId());
      $user->setPassword($this->getValue('new_pass'));
      $user->save();

      if ($this->getValue('send_mail'))
      {
        $this->sendMail($user);
      }

      $con->commit();
    } catch(PDOException $sqle){
      $con->rollBack();
      throw $sqle;
    }catch(Exception $e)
    {
      // in case anything went bad...
      $con->rollBack();
      throw $e;
    }
  }

  public function sendMail($user)
  {
    $mail_address = $user->getsfGuardUserProfiles();
    $mail_address = $mail_address [0];
    $mail_address = $mail_address->getMail();
    chTools::LoadHelpers(array('Url'));
    ProjectConfiguration::registerZend();
    $mail = new Zend_Mail('utf-8');
      $configuration = chTools::get('guard_extra_changed_password', array());
      $configuration = array_merge(array(
                  'from_mail' => 'no-reply@carpe-hora.com',
                  'from_name' => 'carpe-hora.com',
                  'subject'   => 'registration',
                  'html_body' => <<<EOF
          <p>
            Vous avez changé votre mot de passe sur <a href="http://www.t-resa.fr">t-resa.fr</a>.<br />
            Vous pouvez désormais vous connecter avec les informations suivantes:
          </p>
          <ul>
            <li>Pseudo: %USERNAME%</li>
            <li>Mot de passe: %PASSWORD%</li>
          </ul><p>
            Cordialement,<br />
            Toute l'équipe de <a href="http://www.t-resa.fr">t-resa.fr</a>
          </p>
EOF
                  ,
                  'text_body' => <<<EOF
          Vous avez changé votre mot de passe sur http://t-resa.fr.
          Vous pouvez désormais vous connecter avec les informations suivantes:
            * Pseudo: %USERNAME%
            * Mot de passe: %PASSWORD%

          Cordialement,
          Toute l'équipe de t-resa.fr
EOF
                  ),
                  $configuration);

      $mail->setFrom($configuration['from_mail'], $configuration['from_name']);
      $mail->addTo($mail_address);
      $mail->setSubject(__($configuration['subject']));

      $password = $this->getValue('new_pass');

      $array_values = array(
        '%CONNEXION_URL%' => url_for ('chCmsFrontendAccount/signin', true),
        '%USERNAME%' => $user->getUsername(),
        '%PASSWORD%' => $password
      );

      $mail->setBodyHtml(__(
        $configuration['html_body'],
        $array_values
      ));

      $mail->setBodyText(__(
        $configuration['text_body'],
        $array_values
      ));

    $mail->send();

    return $user;
  }

}
