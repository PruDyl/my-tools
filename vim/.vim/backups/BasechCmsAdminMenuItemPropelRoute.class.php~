<?php
/**
 * This file declare the BasechCmsAdminMenuItemPropelRoute class.
 *
 * @package chCmsApplicationPlugin
 * @subpackage Routing
 * @author Julien Muetton <julien_muetton@carpe-hora.com>
 * @copyright (c) Carpe Hora SARL 2011
 * @since 2011-01-03
 */

/**
 * the base class for an object route in the admin panel.
 */
class BasechCmsAdminMenuItemPropelRoute extends sfPropel15Route
{
  /**
   * defines a route for the admin panel.
   * you can pass following parameters :
   *  - module: the admin module to use
   * you can pass following requirements :
   *  - credentials: the required credentials
   *
   * @param string $url the matching url
   * @param array $defaults the default parameters
   * @param array $requirements the route requirements
   * @param array $options the route options
   *
   */
  public function __construct($url, $defaults = array(), $requirements = array(), $options = array())
  {
    if (!isset($options['group']))
    {
      throw new InvalidArgumentException(
              sprintf('You must pass a "group" option for a %s object (%s).', get_class($this), $url));
    }
    if (!isset($options['credentials']))
    {
      throw new InvalidArgumentException(
              sprintf('You must pass a "credentials" option for a %s object (%s).', get_class($this), $url));
    }

    $options['group']->getAdminMenu()->addCredential($options['credentials']);

    parent::__construct($url, $defaults, $requirements, $options);
  }

  /**
   * the function that determines wether or not this is the route to use
   *
   * @return boolean|array
   * @author Julien Muetton <julien_muetton@carpe-hora.com>
   **/
  public function matchesUrl($url, $context = array())
  {
    if (false === $parameters = parent::matchesUrl($url, $context))
    {
      return false;
    }

    if (false === $this->isAccessibleForUser($context['user']))
    {
      throw new sfError404Exception('this content is protected');
      return false;
    }

    return $parameters;
  }

  /**
   * returns the route associated credentials
   *
   * @return array|string
   * @author Julien Muetton <julien_muetton@carpe-hora.com>
   **/
  protected function getCredential()
  {
    return $this->options['credentials'];
  }

  /**
   * checks wether or not the current user has credentials to access this route.
   *
   * @param sfUser $user the current logged in user
   * @return boolean
   */
  public function isAccessibleForUser($user)
  {
    return (bool) $user->hasAdminCredential($this->getCredential());
  }

  public function getDefaultParameters()
  {
    return array_merge(array('sf_route' => $this), parent::getDefaultParameters());
  }

  public function getGroup()
  {
    return $this->options['group'];
  }

  public function getMenu()
  {
    return AdminMenu::getInstance();
  }

  /**
   * the route is not a panel route
   *
   * @return Boolean
   * @author Julien Muetton <julien_muetton@carpe-hora.com>
   **/
  public function isPanelRoute()
  {
    return isset($this->options['component']);
  }

  /**
   * check wether or not this route is an admin action
   *
   * @return Boolean
   * @author Julien Muetton <julien_muetton@carpe-hora.com>
   **/
  public function isActionRoute()
  {
    return !$this->isPanelRoute();
  }

  protected $query;

  /**
   * return the route query class.
   *
   * @return void
   * @author Julien Muetton <julien_muetton@carpe-hora.com>
   **/
  public function getQuery()
  {
    if (!$this->query)
    {
      $this->query = parent::getQuery();
    }

    return $this->query;
  }
} // END OF BasechCmsAdminMenuItemPropelRoute
