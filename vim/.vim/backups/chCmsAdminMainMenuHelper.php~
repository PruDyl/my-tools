<?php

/*------------------------ ADMIN MENU -------------------------*/

/**
 * retrives group from object or id
 *
 * @param AdminGroupMenu|string $group the group to render link to
 *
 * @return AdminGroupMenu
 * @author Julien Muetton <julien_muetton@carpe-hora.com>
 **/
function get_admin_group_menu($group)
{
  if ($group instanceof sfOutputEscaper)
  {
    $group = $group->getRawValue();
  }
  if ($group instanceof AdminGroupMenu)
  {
    return $group;
  }
  AdminMenu::getInstance()->getGroup($group);
}

/**
 * computes HTML for an admin group menu item
 *
 * @param AdminGroupMenu|string $group the group to render link to
 *
 * @return string
 * @author Julien Muetton <julien_muetton@carpe-hora.com>
 **/
function get_admin_menu_group_link($groupMenu)
{
  $groupMenu = get_admin_group_menu($groupMenu);

	$sf_request = sfContext::getInstance()->getRequest();
	$html_options = _parse_attributes($groupMenu->getHtmlOptions());
	$text = app_get_text_for_menu_item($groupMenu->getTitle(), $html_options);
	$html_options = app_get_html_options_for_menu_item($html_options);

  $html_options = _add_class_attribute(get_text_if_current_menu($groupMenu, "selected"), $html_options);

	return link_to1($text, $groupMenu->generateUrl() , $html_options);
}

/**
 * generate html for an admin menu entry
 *
 * @param AdminGroupMenu|string $group the group to render link to
 *
 * @return string
 * @author Julien Muetton <julien_muetton@carpe-hora.com>
 **/
function get_admin_menu_entry_link($groupMenu, $panel_id)
{
  $groupMenu = get_admin_group_menu($groupMenu);

	$html_options = app_get_html_options_for_menu_item(array());
	$text = app_get_text_for_menu_item($groupMenu->getMenuEntry($panel_id), $html_options);
	$url = admin_url_for ($groupMenu, $panel_id);

  //is the route selected
	$sf_request = sfContext::getInstance()->getRequest();
	$route = $groupMenu->getMenuRoute($panel_id);

	if ($sf_request->getAttribute('sf_route')->getPattern() == $route->getPattern())
	{
		$html_options = _add_class_attribute('selected', $html_options);
	}

	return link_to1($text, $url, $html_options);
}

/**
 * Return $text if $group is current
 *
 * @return String
 * @author Ludovic Pell√© <ludovic_pelle@carpe-hora.com>
 **/
function get_text_if_current_menu($group, $text)
{
	if (false !== strpos($sf_request->getAttribute('sf_route')->getPattern(), $group->getUrlPrefix()))
	{
    return $text;
	}
  return '';
}
/**
 * generate url for a menu action.
 * if you are in a menu component, the menu is already registered
 *
 * @param AdminGroupMenu|string  $group    the group to render link to
 * @param string                 $item_id  the item id on which to generate route.
 *
 * @return void
 * @author Julien Muetton <julien_muetton@carpe-hora.com>
 **/
function admin_url_for ($group, $item_id, $parameters = array())
{
  $group = get_admin_group_menu($group);
  return $group->generateUrl($item_id, $parameters);
}
