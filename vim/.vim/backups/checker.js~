(function($, undefined) {
  var _mailReg = /^([A-Za-z0-9_\-\.])+\@([A-Za-z0-9_\-\.])+\.([A-Za-z]{2,4})$/;

  /*
   * Get current value of username input
   */
  function getUser(){
    return $('#sf_guard_user_username').val();
  }

  /*
   * Get current value of username input
   */
  function getMail(){
    return $('#sf_guard_user_mail').val();
  }

  function testMail($mail){
    if(! _mailReg.test($mail.val())){
      var $res = $('.mail-check-field');
       $res
        .empty()
        .append('<span class="ch-icon ch-icon-silk ch-icon-silk-cross"></span>');
        Tresa.openErrorDialog('Email incorrect'));
    }

    return _mailReg.test($mail.val());
  }

  /**
   * Toggles the search loading indicator.
   */
  function toggleLoadingIndicator($input) {
    $input.toggleClass('ui-autocomplete-loading');
  }


  /* check username exist */
  $(function(){
    //Apply lodaing class on delayedActionsEvent
    var $user = $('#sf_guard_user_username'),
        $mail = $('#sf_guard_user_mail');

    // create the result recipient
    $user.after('<span class="check-field username-check-field" />');
    $mail.after('<span class="check-field mail-check-field" />');

    $user
      .delayAction({
        'delayedActionTriggered': function(){toggleLoadingIndicator.call(null,$user);},
        'action': {
          url: Routing.generate('username_search'),
          data: function() { return 'username=' + getUser(); },
          dataType: 'json',
          complete: function(){toggleLoadingIndicator($user);},
          error: function(data) {
            Tresa.openErrorDialog("Erreur lors de l'appel AJAX.");
          },
          success: function(data) {
            var $res = $('.username-check-field');
            $res
              .empty()
              .append(data.icon);
            if(!data.ok){
              Tresa.openErrorDialog(data.message);
            }
          }
        },
        'delay': 500
      });

     /* check mail exist */
     $mail
      .delayAction({
        'delayedActionTriggered':function(){toggleLoadingIndicator.call(null, $mail); },
        'condition': function(){return testMail.call(null, $mail)},
        'action': {
          url: Routing.generate('mail_search'),
          data: function() { return 'mail=' + getMail(); },
          dataType: 'json',
          complete: function(){toggleLoadingIndicator($mail);},
          error: function(data) {
            Tresa.openErrorDialog("Erreur lors de l'appel AJAX.");
          },
          success: function(data) {
            var $res = $('.mail-check-field');
            $res
              .empty()
              .append(data.icon);
            if(!data.ok){
              Tresa.openErrorDialog(data.message);
            }
          }
        },
        'delay': 500
      });

    /* check on start if prefilled */
    if($mail.val()){
      $mail.change();
    }
    if($user.val()){
      $user.change();
    }
  }); /* end of onload */
})(jQuery);
