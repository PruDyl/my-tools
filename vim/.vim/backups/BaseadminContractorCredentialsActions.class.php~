<?php

/**
 * Base actions for the chCmsAdminContractorPlugin adminContractorCredentials module.
 * 
 * @package     chCmsAdminContractorPlugin
 * @subpackage  module-adminContractorCredentials
 * @author      Julien Muetton <julien_muetton@carpe-hora.com>
 * @version     SVN: $Id$
 */
abstract class BaseadminContractorCredentialsActions extends chCmsAdminPanelActions
{
  /**
   * the preexecute function
   *
   * @return void
   * @author Julien Muetton <julien_muetton@carpe-hora.com>
   **/
  public function preExecute()
  {
    AdminContractorEntityTools::preExecuteCredentials($this->getRoute(),$this->getUser());
  }
  
  /**
   * entry point for Update action
   *
   * @param sfWebRequest $request the user request
   * @return 
   */
  public function executeUpdate(sfWebRequest $request)
  {
    $contractors = $this->getUser()->getSelectedCompany()->getContractors();

    $form = new DefaultContractorCredentialsForm(null, array('contractors' => $contractors));

    $this->processForm($form, $this->getRequest());

    $this->contractorNames = AdminContractorEntityTools::getCredentialListHeader($contractors);

    $this->form = $form;
    $this->setTemplate('rights');
  }

  /**
   * process the form
   *
   * @return void
   * @author Julien Muetton <julien_muetton@carpe-hora.com>
   **/
  protected function processForm($form, $request)
  {
    $form->bind($request->getParameter($form->getName()), $request->getFiles($form->getName()));

    if ($form->isValid())
    {
      $form->save();

      $this->getUser()->addInfo('Les permissions ont été mises à jour');

      $this->redirect('rights');
    }
    else
    {
      foreach ($form->getFormattedErrors() as $id => $error) 
      {
        $this->getUser()->addError($error);
      }
    }
  }
}
