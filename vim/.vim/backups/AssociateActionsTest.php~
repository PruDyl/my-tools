<?php

$app = 'users';

include(dirname(__FILE__).'/../../../../test/bootstrap/functional.php');

$browser = TresaTestFunctional::initialize(false);
$browser->info('@see chCmsGuardExtraActionsTest.php');
/*
// an user already uses our Google Account ...
$auth = TresaTestFunctional::getFirstProvider('pro2');
$auth->delete();


function goToRegisterProvider($browser)
{
  $browser->get('/');
//  $_SERVER['SERVER_NAME'] = 'users-dev.my-t-resa.loc';
  $openid = new GoogleOpenIdConsumerTester('http://'.$_SERVER['SERVER_NAME'], $browser->getRequest());
  $openid->prepareValidRequest($browser->getRequest());
  $params = $browser->getRequest()->getParameterHolder()->getAll();


  $browser
    ->info('Authentify with Google')
    ->get('/register/google/verify', $params)
      ->with('request')->begin()
        ->isParameter('module', 'GoogleAuthentication')
        ->isParameter('action', 'verify')
      ->end() // end on response block

    ->get('/register')
      ->with('request')->begin()
      ->isMethod('get')
      ->isParameter('module', 'chCmsFrontendSignup')
      ->isParameter('action', 'register')
    ->end();

    return $browser;
}

// begin: tests
 goToRegisterProvider($browser)
  ->info("> 1 Submit an invalid association form")
    ->click('#signin-link-to-existing-account button[type="submit"]', array('associate' => array('username' => 'foo', 'password' => 'bar')))

    ->with('form')->begin()
      ->hasErrors(1)
      ->isError('username', 'invalid')
    ->end();

goToRegisterProvider($browser)
  ->info("> 2 Submit an invalid association form (non existent user)")
    ->click('#signin-link-to-existing-account button[type="submit"]', array('associate' => array('username' => 'demoooooooo', 'password' => 'demo')))

    ->with('form')->begin()
      ->hasErrors(true)
      ->isError('username', 'invalid')
    ->end();

goToRegisterProvider($browser)
  ->info("> 3 Submit an invalid association form (incorrect password)")
    ->click('#signin-link-to-existing-account button[type="submit"]', array('associate' => array('username' => 'demo', 'password' => 'foobar')))

    ->with('form')->begin()
      ->hasErrors(true)
      ->isError('username', 'invalid')
    ->end();

goToRegisterProvider($browser)
  ->info("> 4 Submit a valid association form")
    ->click('#signin-link-to-existing-account button[type="submit"]', array('associate' => array('username' => 'demo', 'password' => 'demo')))

    ->with('form')->begin()
      ->hasErrors(false)
    ->end()

    ->with('request')->isRedirected()
    ->followRedirect()

    ->with('request')->begin()
      ->isParameter('module', 'chCmsFrontendAccount')
      ->isParameter('action', 'index')
    ->end() // end on request block

;*/
// vim: ft=symfony.php.sftest
