<?php
/**
 * this file contains the test strategy for the user login and account
 *
 * @author Julien Muetton <julien_muetton@carpe-hora.com>
 * @version $Id$
 * @copyright Carpe Hora, 15 February, 2011
 * @package     T-resa
 * @subpackage  tests
 **/

$app= "users";

include(dirname(__FILE__).'/../../bootstrap/functional.php');

$browser = TresaTestFunctional::initialize(/* we do need to load data */ true);

$browser
  ->info('1 - Login and display account page')
  ->info('>1.1 - Homepage')
  ->get('/')
    ->with('request')->begin()
      ->isMethod('get')
      ->isParameter('module', 'home')
      ->isParameter('action', 'index')
    ->end()
    ->with('response')->begin()
      ->isStatusCode(200)
      ->isValid()
    ->end()

  ->info('>1.2 - Preview')
  ->get('/apercu')
  ->isStatusCode(200)

  ->info('>1.3 - About')
  ->get('/a-propos')
  ->isStatusCode(200)

  ->info('>1.4 - Help')
  ->get('/aide')
  ->isStatusCode(200)

  ->info('Check the lost password page')
    ->get('/mot-de-passe-perdu')

    //check routing is OK
    ->with('request')->begin()
      ->isMethod('get')
      ->isParameter('module', 'chCmsFrontendSignup')
      ->isParameter('action', 'lostPassword')
    ->end()

    // check the response
    ->with('response')->begin()
      ->isStatusCode(200)
      ->isValid()
      // check there is a form
      ->checkForm(new chCmsUserResendPasswordForm())
    ->end()
    // end of get /mot-de-passe-perdu
    ->info("send form")
      ->click('button[type="submit"]', array(
                    'reset_password' => array('email' => 'demo@user.com'),))

      ->with('response')->isRedirected()

      ->with('request')->begin()
        ->isMethod('post')
        ->isParameter('module', 'chCmsFrontendSignup')
        ->isParameter('action', 'requestNewPassword')
      ->end() // end on request block

      ->with('mailer')->begin()
        ->hasSent(1)
        ->checkHeader('Subject', '/^Votre nouveau mot de passe t-resa.fr$/')
        // split text as it is a mail
        ->checkBody('/Pour changer votre mot de passe, cliquez sur le l/')
        ->checkBody('/href="http:\/\//')
      ->end() // end on mailer block

      ->followRedirect()

      ->with('request')->begin()
        ->isParameter('module', 'chCmsFrontendAccount')
        ->isParameter('action', 'signin')
      ->end() // end on request block

  // end of lost password
;

// retrieve the new activation token
$token = GuardExtraPasswordChangeTokenQuery::create()
            ->joinWithsfGuardUser()
            ->usesfGuardUserQuery()
              ->filterByUserName('demo')
            ->endUse()
            ->find();

$browser
  ->info("now simulate user click for password resent")
  ->test()->is(count($token), 1, 'there is one and only one token for demo');

$token = $token[0];

$browser
  ->get(strtr('/regenerer-mon-mot-de-passe/:token/:id/:username', array(
          ':token'     => $token->getToken(),
          ':id'        => $token->getsfGuardUserId(),
          ':username'  => $token->getsfGuardUser()->getUsername())))

 //check routing is OK
  ->with('request')->begin()
    ->isMethod('get')
    ->isParameter('module', 'chCmsFrontendSignup')
    ->isParameter('action', 'regeneratePassword')
  ->end()

  // check the response is a redirect
  ->with('response')->isRedirected()

  ->with('mailer')->begin()
    ->hasSent(1)
    ->checkHeader('Subject', '/^Votre nouveau mot de passe t-resa.fr$/')
    // split text as it is a mail
    ->checkBody('/href="http:\/\//')
    ->checkBody('/Votre nouveau mot de passe est :/')
  ->end() // end on mailer block

  ->followRedirect()

  ->with('request')->begin()
    ->isParameter('module', 'chCmsFrontendAccount')
    ->isParameter('action', 'signin')
  ->end() // end on response block
  // end of get /regenerer-mon-mot-de-passe/:token/:id/:username

  // end of block now simulate user click for password resent
;
// vim: ft=symfony.php.sftest
