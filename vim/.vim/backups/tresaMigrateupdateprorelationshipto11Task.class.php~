<?php
/**
 * @package    T-resa-lib
 * @subpackage  default
 * @author     Julien Muetton <julien_muetton@carpe-hora.com>
 * @copyright  (c) Carpe Hora SARL 2011
 */
/**
 * this file declares the tresaMigrateupdateprorelationshipto11Task class.
 * this is the class behind symfony t-resa:migrate-update-pro-relationship-to-11
 *
 * @package T-resa-lib
 * @subpackage Migrations
 * @author Julien Muetton <julien_muetton@carpe-hora.com>
 * @copyright (c) Carpe Hora SARL 2010
 * @since 2010-12-10
 */

/**
 * The t-resa:migrate-update-pro-relationship-to-11 task migrate some tables to 1 to 1 relationship
 */
class tresaMigrateupdateprorelationshipto11Task extends BaseTresaMigrationTask
{
  protected function configure()
  {
    // // add your own arguments here
    // $this->addArguments(array(
    //   new sfCommandArgument('my_arg', sfCommandArgument::REQUIRED, 'My argument'),
    // ));

    parent::configure();

    $this->name             = 'migrate-update-pro-relationship-to-11';
    $this->briefDescription = 'migrate some tables to 1 to 1 relationship';
    $this->detailedDescription = <<<EOF
The [t-resa:migrate-update-pro-relationship-to-11|INFO] task migrate some tables to 1 to 1 relationship
call it with:

  [php symfony t-resa:migrate-update-pro-relationship-to-11|INFO]
EOF;
  }

  /**
   * actually migrate the database.
   *
   * @param PropelPDO $con the db connection to use
   * @throw sfPropelException
   */
  protected function doUpdateDb($con)
  {
    //-------------------------- MIGRATE CONTRACT ---------------------------------

    $this->logSection($this->name, 'delete the contract properties foreign key');

    $sql=<<<EOF
ALTER TABLE `tab_contract_property`
    DROP INDEX `tab_contract_property_FI_1`,
    DROP FOREIGN KEY `tab_contract_property_FK_1`;
EOF;
    $stmt = $con->prepare($sql);
    $stmt->execute(array());
    $this->logSection($this->name, 'delete the contract properties foreign key OK');

    $this->logSection($this->name, 'update the contract properties contract_id values');

    $sql=<<<EOF
UPDATE `tab_contract_property`
SET `contract_id` = (
      SELECT `tab_contract`.`company_id`
        FROM `tab_contract`
        WHERE `tab_contract_property`.`contract_id` = `tab_contract`.`id`
    )
WHERE 1;
EOF;
    $stmt = $con->prepare($sql);
    $stmt->execute(array());
    $this->logSection($this->name, 'update the contract properties contract_id values OK');

    $this->logSection($this->name, 'remove the CompanyEntityConfig id');

    $sql=<<<EOF
ALTER TABLE `tab_contract`
    DROP PRIMARY KEY ,
    DROP `id`,
    ADD PRIMARY KEY ( `company_id` ) ;
EOF;
    $stmt = $con->prepare($sql);
    $stmt->execute(array());
    $this->logSection($this->name, 'remove the CompanyEntityConfig id OK');

    $this->logSection($this->name, 'set the new foreign key on contract_properties');

    $sql=<<<EOF
ALTER TABLE `tab_contract_property`
  ADD INDEX `tab_contract_property_FI_1` (`contract_id`),
  ADD CONSTRAINT `tab_contract_property_FK_1`
    FOREIGN KEY (`contract_id`)
    REFERENCES `tab_contract` (`company_id`)
    ON UPDATE CASCADE
    ON DELETE CASCADE
EOF;
    $stmt = $con->prepare($sql);
    $stmt->execute(array());
    $this->logSection($this->name, 'set the new foreign key on contract_properties OK');


    //------------------------- MIGRATE CompanyPreferences ------------------------

    $this->logSection($this->name, 'removes the CompanyPreferences id field');

    $sql=<<<EOF
ALTER TABLE `tab_company_preferences`
    DROP PRIMARY KEY ,
    DROP INDEX `FI_tab_company_preferences_company`,
    DROP FOREIGN KEY `fk_tab_company_preferences_company`,
    DROP `id`;
EOF;
    $stmt = $con->prepare($sql);
    $stmt->execute(array());

    $this->logSection($this->name, 'HALF WAY removes the CompanyPreferences id field');

    $sql=<<<EOF
ALTER TABLE `tab_company_preferences`
  ADD PRIMARY KEY (`company_id`),
  ADD CONSTRAINT `fk_tab_company_preferences_company`
    FOREIGN KEY (`company_id`)
    REFERENCES `tab_company` (`id`)
    ON DELETE CASCADE
EOF;
    $stmt = $con->prepare($sql);
    $stmt->execute(array());
    $this->logSection($this->name, 'removes the CompanyPreferences id field OK');

    //------------------------- MIGRATE CompanyVocabulary  ------------------------

    $this->logSection($this->name, 'removes the CompanyVocabulary id field');

    $sql=<<<EOF
ALTER TABLE `tab_company_vocabulary`
    DROP PRIMARY KEY ,
    DROP INDEX `FI_tab_company_vocabulary_company`,
    DROP FOREIGN KEY `fk_tab_company_vocabulary_company`,
    DROP `id`;
EOF;
    $stmt = $con->prepare($sql);
    $stmt->execute(array());

    $this->logSection($this->name, 'HALF WAY removes the CompanyVocabulary id field');

    $sql=<<<EOF
ALTER TABLE `tab_company_vocabulary`
  ADD PRIMARY KEY (`company_id`),
  ADD CONSTRAINT `fk_tab_company_vocabulary_company`
    FOREIGN KEY (`company_id`)
    REFERENCES `tab_company` (`id`)
    ON DELETE CASCADE
EOF;
    $stmt = $con->prepare($sql);
    $stmt->execute(array());
    $this->logSection($this->name, 'removes the CompanyVocabulary id field OK');

  }
} //end of class tresaMigrateupdateprorelationshipto11Task
// vim:ft=php.tresatask
